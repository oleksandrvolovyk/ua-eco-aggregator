<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/static/scrapers.css" type="text/css">
    <title>Admin Frontend - Scrapers</title>
</head>
<body>

<h1>Scrapers</h1>

<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>API Key</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    <!-- Loop through the list of scrapers -->
    <tr th:each="scraper : ${scrapers}">
        <td th:text="${scraper.id}"></td>
        <td>
            <!-- Editable name field -->
            <input type="text" name="name" th:value="${scraper.name}"/>
            <button th:onclick="saveEdits([[${scraper.id}]], this.parentElement.children[0].value, [[${scraper.apiKey}]])">
                Save
            </button>
        </td>
        <td>
            <!-- Editable apiKey field -->
            <input type="text" name="apiKey" th:value="${scraper.apiKey}"/>
            <button th:onclick="saveEdits([[${scraper.id}]], [[${scraper.name}]], this.parentElement.children[0].value)">
                Save
            </button>
        </td>
        <td>
            <!-- Delete button -->
            <button th:onclick="deleteScraper([[${scraper.id}]])">Delete</button>
            <!-- View details button -->
            <a th:href="@{~/scrapers/{scraperId}(scraperId=${scraper.id})}">
                <button>View details</button>
            </a>
        </td>
    </tr>
    </tbody>
</table>

<h3>Create new Scraper</h3>

<!-- New Scraper Form -->
<form id="newScraperForm">
    <div>
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>

    <div>
        <label for="apiKey">API key:</label>
        <input type="text" id="apiKey" name="apiKey" required>
    </div>

    <button type="button" onclick="submitNewScraper()">Submit new Scraper</button>
<script>
    function saveEdits(scraperId, scraperName, scraperApiKey) {
        const jsonData = {
            'name': scraperName,
            'apiKey': scraperApiKey
        }

        fetch(`/api/scrapers/${scraperId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                alert("Changes saved successfully!");
                console.log("Changes saved!");
            })
            .catch(error => {
                // Handle errors
                alert("Failed to save changes :(");
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function deleteScraper(scraperId) {
        fetch(`/api/scrapers/${scraperId}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                alert("Changes saved successfully!");
                console.log("Changes saved!");
                window.location.reload()
            })
            .catch(error => {
                // Handle errors
                alert("Failed to save changes :(");
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    function submitNewScraper() {
        // Get form data
        const name = document.getElementById("name").value;
        const apiKey = document.getElementById("apiKey").value;

        // Create JSON data
        const jsonData = {
            'name': name,
            'apiKey': apiKey
        };

        // Make a fetch POST request to create a new scraper
        fetch('/api/scrapers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                window.location.reload();
            })
            .catch(error => {
                // Handle errors
                alert("Failed to create new Scraper :(")
                console.log('There was a problem with the fetch operation:', error);
            });
    }
</script>

</body>
</html>
